# Nginx 主配置文件 (开发环境 - 使用 8080 端口)

# 用户和工作进程
worker_processes  1;

# 错误日志
error_log  logs/error.log  warn;
pid        logs/nginx.pid;

# 事件模块
events {
    worker_connections  1024;
}

# HTTP 模块
http {
    include       mime.types;
    default_type  application/octet-stream;

    # 日志格式
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for" '
                      'rt=$request_time uct="$upstream_connect_time" '
                      'uht="$upstream_header_time" urt="$upstream_response_time"';

    access_log  logs/access.log  main;

    # 性能优化
    sendfile        on;
    keepalive_timeout  65;

    # Gzip 压缩
    gzip  on;
    gzip_vary on;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript 
               application/json application/javascript application/xml+rss;

    # 上游服务器 (Spring Cloud Gateway)
    upstream gateway_backend {
        server localhost:10010 weight=1 max_fails=3 fail_timeout=30s;
        keepalive 32;
    }

    # HTTP 服务器 (使用 8005 端口，不需要管理员权限)
    server {
        listen       8005;
        server_name  localhost;

        # 字符集
        charset utf-8;

        # 访问日志
        access_log  logs/host.access.log  main;

        # 跨域配置
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization" always;

        # OPTIONS 请求直接返回
        if ($request_method = 'OPTIONS') {
            return 204;
        }

        # 根路径 - 欢迎页面
        location / {
            root   html;
            index  index.html index.htm;
        }

        # 静态资源缓存
        location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
            root   html;
            expires 30d;
            add_header Cache-Control "public, immutable";
            access_log off;
        }

        # API 请求转发到 Gateway
        location /api/ {
            proxy_pass http://gateway_backend/;
            
            # 代理头设置
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # 超时设置
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            
            # HTTP 1.1 支持
            proxy_http_version 1.1;
            proxy_set_header Connection "";
        }

        # 健康检查
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # 错误页面
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }
}
