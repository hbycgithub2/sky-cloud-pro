# LoadBalancer（负载均衡器）

---

## 🎯 10秒版 - 面试快答

**核心亮点：**
```
LoadBalancer客户端负载均衡，解决三大问题：
1. 多实例选择(从多个实例中选一个)
2. 流量分配(轮询/随机/权重策略)
3. 故障转移(自动剔除故障实例)
```

**一句话：** Spring Cloud LoadBalancer客户端负载均衡器，从Nacos获取服务实例列表，按策略选择一个实例进行调用

**更接地气：** LoadBalancer就是微服务的"智能调度员"，有3台服务器可以用，它帮你选一台最合适的，轮流用或者随机选

---

## 📋 技术要点 - 工作使用

### 定义
Spring Cloud LoadBalancer客户端负载均衡器，替代Ribbon，集成在Feign和RestTemplate中

### 核心功能
- **实例选择**：从Nacos获取的实例列表中选择一个健康实例
- **负载均衡策略**：支持轮询（默认）、随机、权重等策略
- **健康检查**：只选择健康的实例，自动剔除故障实例
- **缓存机制**：缓存实例列表，减少对Nacos的查询

### 核心价值
```
解决问题1：单实例压力大 → 多实例分流(流量均匀分配)
解决问题2：手动选择实例 → 自动选择(按策略智能选择)
解决问题3：故障实例影响调用 → 自动剔除(只选健康实例)
```

### 和其他技术关系
```
Nacos(8848) - 注册中心，提供服务实例列表
LoadBalancer - 负载均衡器，从实例列表中选择一个
Feign - HTTP客户端，集成LoadBalancer实现负载均衡
```

### 关键配置
```yaml
# application.yml
spring:
  cloud:
    loadbalancer:
      ribbon:
        enabled: false              # 禁用Ribbon
      cache:
        enabled: true               # 开启缓存
        ttl: 35s                    # 缓存时间
```

---

## 🔧 深度解析 - 问题解决

### 实际案例（sky-cloud-pro项目）

**场景：orderservice调用userservice，userservice有3个实例**

```
完整流程：
1. userservice启动3个实例：
   - 实例1：192.168.1.1:8001
   - 实例2：192.168.1.2:8001
   - 实例3：192.168.1.3:8001
   - 都注册到Nacos

2. orderservice调用userservice：
   - Feign调用：userClient.getUserById(123)
   - Feign查询Nacos：获取userservice实例列表
   - Nacos返回：[实例1, 实例2, 实例3]

3. LoadBalancer负载均衡：
   - 策略：轮询（RoundRobin）
   - 第1次调用：选择实例1 (192.168.1.1:8001)
   - 第2次调用：选择实例2 (192.168.1.2:8001)
   - 第3次调用：选择实例3 (192.168.1.3:8001)
   - 第4次调用：选择实例1 (192.168.1.1:8001)
   - 循环往复

4. 故障转移：
   - 实例2挂了，Nacos标记为不健康
   - LoadBalancer获取实例列表：[实例1, 实例3]（不包含实例2）
   - 第1次调用：选择实例1
   - 第2次调用：选择实例3
   - 第3次调用：选择实例1
   - 自动剔除故障实例，用户无感知
```

### 问题解决（真实踩坑）

**问题1：所有请求都打到一台服务器，其他服务器闲置**

问题流程：
```
3台服务器 → 所有请求打到第1台 → 第1台压力大 → 其他2台闲置
```

解决方案：使用LoadBalancer轮询策略

解决流程：
```
问题前：
所有请求 → 第1台服务器 → 压力大，响应慢

问题后：
LoadBalancer轮询 → 第1次请求到第1台 → 第2次请求到第2台 → 第3次请求到第3台
流量均匀分配，压力分散
```

关键代码：
```java
// 默认就是轮询策略，无需配置
@FeignClient(value = "userservice")
public interface UserClient {
    @GetMapping("/user/{id}")
    User getUserById(@PathVariable("id") Long id);
}
```

---

**问题2：想让性能好的服务器多处理请求，性能差的少处理**

问题流程：
```
轮询策略 → 每台服务器请求数相同 → 性能差的服务器压力大
```

解决方案：使用权重策略

解决流程：
```
问题前：
轮询策略 → 每台服务器1/3请求 → 性能差的服务器响应慢

问题后：
权重策略 → 性能好的服务器权重2.0 → 处理2/3请求
         → 性能差的服务器权重1.0 → 处理1/3请求
```

关键代码：
```yaml
# Nacos配置实例权重
spring:
  cloud:
    nacos:
      discovery:
        weight: 2.0  # 权重2.0，处理更多请求
```

---

**问题3：某台服务器挂了，还往那台发请求，报错**

问题流程：
```
服务器挂了 → LoadBalancer还选择该实例 → 请求失败 → 用户报错
```

解决方案：Nacos健康检查，LoadBalancer只选健康实例

解决流程：
```
问题前：
服务器挂了 → LoadBalancer不知道 → 还往那台发请求 → 请求失败

问题后：
服务器挂了 → Nacos标记不健康 → LoadBalancer获取实例列表时过滤掉
         → 只选择健康实例 → 请求成功
```

关键代码：
```yaml
# Nacos健康检查配置
spring:
  cloud:
    nacos:
      discovery:
        heart-beat-interval: 5000      # 5秒心跳
        heart-beat-timeout: 15000      # 15秒超时
```

### 性能数据

```
LoadBalancer性能：
- 实例选择：微秒级（从缓存中选择）
- 缓存更新：35秒（默认TTL）
- 支持实例数：1000+

负载均衡效果：
- 3台服务器：流量1:1:1均匀分配
- 权重策略：按权重比例分配
- 故障转移：自动剔除故障实例
```

---

## 📝 使用建议

- **面试场景**：只说"10秒版"，面试官追问再说"技术要点"
- **技术文档**：用"技术要点"，简洁专业
- **实际工作**：用"深度解析"，有案例有代码
- **快速查阅**：看"10秒版"和"关键配置"

---

**最后更新：** 2026-01-29  
**适用场景：** 面试、工作、学习
