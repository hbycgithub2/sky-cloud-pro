# Gatewayï¼ˆåº”ç”¨ç½‘å…³ï¼‰- è¯¦ç»†ç‰ˆ

> å®Œæ•´çš„5å±‚é€’è¿›ç»“æ„ï¼ŒåŒ…å«æ‰€æœ‰ç»†èŠ‚ã€é—®é¢˜è§£å†³ã€æ€§èƒ½æ•°æ®

---

## ğŸ“‹ ç‰ˆæœ¬è¯´æ˜

- **Gateway.md** - ç²¾ç®€ç‰ˆï¼ˆé¢è¯•/å¿«é€ŸæŸ¥é˜…ï¼‰
- **Gateway-è¯¦ç»†ç‰ˆ.md** - æœ¬æ–‡ä»¶ï¼ˆæ·±å…¥å­¦ä¹ /å®Œæ•´å‚è€ƒï¼‰

---

## ã€ç‰ˆæœ¬A - æç®€æ ¸å¿ƒã€‘ç»ˆæç‰ˆ

### ç¬¬1å±‚ï¼šä¸»æ—¨ï¼ˆæ ¸å¿ƒä¸­çš„æ ¸å¿ƒï¼‰

```
Gatewayåº”ç”¨ç½‘å…³ï¼Œå¾®æœåŠ¡ä¸šåŠ¡å±‚ç»Ÿä¸€å…¥å£ï¼Œè§£å†³å‰ç«¯å¤šåœ°å€å’Œé‡å¤é‰´æƒé—®é¢˜
ç«¯å£10010ï¼Œé…ç½®routesè·¯ç”±è§„åˆ™ï¼Œç»“åˆNacosåŠ¨æ€æœåŠ¡å‘ç°
```

### ç¬¬2å±‚ï¼šæ ¸å¿ƒä»·å€¼

```
ç»Ÿä¸€å…¥å£(å‰ç«¯ä¸€ä¸ªåœ°å€) + ç»Ÿä¸€é‰´æƒ(ä¸€å¤„éªŒè¯å…¨å±€ç”Ÿæ•ˆ) + åŠ¨æ€è·¯ç”±(è‡ªåŠ¨å‘ç°æœåŠ¡)
```

### ç¬¬3å±‚ï¼šå®é™…æ¡ˆä¾‹ï¼ˆä½ çš„é¡¹ç›®ï¼‰

**åœºæ™¯ï¼šç”¨æˆ·æŸ¥è¯¢è®¢å•åˆ—è¡¨**

```
æµç¨‹ï¼š
1. å‰ç«¯è¯·æ±‚ï¼šlocalhost:8005/api/order/list (å¸¦Token)
2. Nginxè½¬å‘ï¼šå»æ‰/api/ï¼Œè½¬åˆ°Gateway(10010)
3. GatewayéªŒè¯ï¼šæ£€æŸ¥Tokenæœ‰æ•ˆæ€§ï¼Œè§£æuserId
4. Gatewayè·¯ç”±ï¼šåŒ¹é…/order/**è§„åˆ™ï¼Œæ‰¾åˆ°orderservice
5. NacosæŸ¥è¯¢ï¼šè¿”å›orderserviceçš„3ä¸ªå®ä¾‹[8081,8082,8083]
6. è´Ÿè½½å‡è¡¡ï¼šè½®è¯¢é€‰æ‹©8081
7. è½¬å‘è¯·æ±‚ï¼šå¸¦ä¸ŠuserIdï¼Œè½¬å‘åˆ°orderservice(8081)
8. è¿”å›æ•°æ®ï¼šåªè¿”å›è¯¥ç”¨æˆ·çš„è®¢å•
```

### ç¬¬4å±‚ï¼šé—®é¢˜è§£å†³

**é—®é¢˜1ï¼šTokenéªŒè¯æ¯ä¸ªæœåŠ¡éƒ½è¦å†™ï¼Œé‡å¤100é**
```
è§£å†³ï¼šGatewayç»Ÿä¸€éªŒè¯ï¼Œåç«¯æœåŠ¡ä»Headerå–userIdå³å¯
```

**é—®é¢˜2ï¼šorderserviceä»8082æ”¹åˆ°9092ï¼Œå‰ç«¯è¦æ”¹é…ç½®**
```
è§£å†³ï¼šåªéœ€åœ¨Nacosæ”¹æ³¨å†Œåœ°å€ï¼ŒGatewayè‡ªåŠ¨å‘ç°ï¼Œå‰ç«¯æ— æ„ŸçŸ¥
```

**é—®é¢˜3ï¼šæŸä¸ªæœåŠ¡æŒ‚äº†ï¼Œè¯·æ±‚è¿˜å¾€é‚£å°å‘ï¼ŒæŠ¥é”™**
```
è§£å†³ï¼šGatewayç»“åˆNacoså¥åº·æ£€æŸ¥ï¼Œè‡ªåŠ¨å‰”é™¤æ•…éšœå®ä¾‹
```

### ç¬¬5å±‚ï¼šå…³é”®é…ç½®

```yaml
# gateway/application.yml
routes:
  - id: order-service
    uri: lb://orderservice          # lb=è´Ÿè½½å‡è¡¡
    predicates:
      - Path=/order/**               # è·¯å¾„åŒ¹é…
    filters:
      - StripPrefix=0                # ä¸å»å‰ç¼€
```

---

## ã€ç‰ˆæœ¬B - æŠ€æœ¯å‡†ç¡®ã€‘ç»ˆæç‰ˆ

### ç¬¬1å±‚ï¼šä¸»æ—¨ï¼ˆæ ¸å¿ƒä¸­çš„æ ¸å¿ƒï¼‰

```
Spring Cloud Gatewayåº”ç”¨ç½‘å…³ï¼ŒåŸºäºWebFluxå“åº”å¼ç¼–ç¨‹ï¼Œå¾®æœåŠ¡ä¸šåŠ¡å±‚ç»Ÿä¸€å…¥å£
æ ¸å¿ƒåŠŸèƒ½ï¼šæœåŠ¡è·¯ç”±åˆ†å‘ã€ç»Ÿä¸€é‰´æƒã€è´Ÿè½½å‡è¡¡ã€é™æµç†”æ–­
ç«¯å£10010ï¼Œé€šè¿‡predicatesåŒ¹é…è·¯ç”±è§„åˆ™ï¼Œç»“åˆNacoså®ç°åŠ¨æ€æœåŠ¡å‘ç°
```

### ç¬¬2å±‚ï¼šæ ¸å¿ƒä»·å€¼

```
è§£å†³é—®é¢˜1ï¼šå‰ç«¯å¤šåœ°å€ â†’ ç»Ÿä¸€å…¥å£(ä¸€ä¸ªåœ°å€è®¿é—®æ‰€æœ‰æœåŠ¡)
è§£å†³é—®é¢˜2ï¼šé‡å¤é‰´æƒ â†’ ç»Ÿä¸€é‰´æƒ(Gateway Filterä¸€å¤„éªŒè¯ï¼Œ100ä¸ªæœåŠ¡ç”Ÿæ•ˆ)
è§£å†³é—®é¢˜3ï¼šåœ°å€ç¡¬ç¼–ç  â†’ åŠ¨æ€è·¯ç”±(Nacosè‡ªåŠ¨å‘ç°ï¼ŒæœåŠ¡ä¸Šä¸‹çº¿æ— éœ€é‡å¯)
è§£å†³é—®é¢˜4ï¼šå•ç‚¹æ•…éšœ â†’ è´Ÿè½½å‡è¡¡(å¤šå®ä¾‹è‡ªåŠ¨åˆ‡æ¢)
```

### ç¬¬3å±‚ï¼šå®é™…æ¡ˆä¾‹ï¼ˆä½ çš„é¡¹ç›®ï¼‰

**åœºæ™¯ï¼šç”¨æˆ·ä¸‹å•æµç¨‹**

```
1. å‰ç«¯è¯·æ±‚ï¼šPOST localhost:8005/api/order/create (å¸¦Tokenå’Œè®¢å•æ•°æ®)

2. Nginxæ¥æ”¶ï¼šå»æ‰/api/å‰ç¼€ï¼Œè½¬å‘åˆ°Gateway(10010)

3. Gatewayé‰´æƒï¼š
   - éªŒè¯Tokenç­¾åå’Œè¿‡æœŸæ—¶é—´
   - è§£æuserId=123
   - å°†userIdæ”¾å…¥Headerä¼ é€’ç»™åç«¯

4. Gatewayè·¯ç”±ï¼š
   - åŒ¹é…predicates: Path=/order/**
   - æ‰¾åˆ°routesé…ç½®çš„orderservice

5. NacosæœåŠ¡å‘ç°ï¼š
   - æŸ¥è¯¢orderserviceçš„æ‰€æœ‰å¥åº·å®ä¾‹
   - è¿”å›ï¼š[192.168.1.1:8081, 192.168.1.2:8082, 192.168.1.3:8083]

6. è´Ÿè½½å‡è¡¡ï¼š
   - ä½¿ç”¨è½®è¯¢ç­–ç•¥é€‰æ‹©192.168.1.1:8081

7. è½¬å‘è¯·æ±‚ï¼š
   - è½¬å‘åˆ°orderservice(8081)
   - Headerå¸¦ä¸ŠuserId=123

8. orderserviceå¤„ç†ï¼š
   - ä»Headerå–userId
   - åˆ›å»ºè®¢å•ï¼Œå…³è”userId
   - è¿”å›è®¢å•å·

9. åŸè·¯è¿”å›ï¼šGateway â†’ Nginx â†’ å‰ç«¯
```

### ç¬¬4å±‚ï¼šé—®é¢˜è§£å†³

**é—®é¢˜1ï¼šTokenéªŒè¯é€»è¾‘æ¯ä¸ªæœåŠ¡éƒ½è¦å†™ï¼Œä»£ç é‡å¤**

è§£å†³ï¼šGatewayå†™ä¸€ä¸ªGlobalFilterï¼Œç»Ÿä¸€éªŒè¯Token

```java
@Component
public class AuthFilter implements GlobalFilter {
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        // 1. è·å–Token
        String token = exchange.getRequest().getHeaders().getFirst("Authorization");
        
        // 2. éªŒè¯Token
        if (token == null || !JwtUtil.verify(token)) {
            exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);
            return exchange.getResponse().setComplete();
        }
        
        // 3. è§£æuserIdï¼Œä¼ é€’ç»™åç«¯
        Long userId = JwtUtil.getUserId(token);
        ServerHttpRequest request = exchange.getRequest().mutate()
            .header("userId", userId.toString())
            .build();
        
        // 4. æ”¾è¡Œ
        return chain.filter(exchange.mutate().request(request).build());
    }
}
```

**é—®é¢˜2ï¼šorderserviceä»8082æ”¹åˆ°9092ï¼ŒGatewayé…ç½®è¦æ”¹**

è§£å†³ï¼šä¸è¦å†™å›ºå®šåœ°å€ï¼Œç”¨lb://serviceNameï¼ŒNacosè‡ªåŠ¨å‘ç°

```yaml
# âŒ é”™è¯¯é…ç½®ï¼ˆç¡¬ç¼–ç åœ°å€ï¼‰
uri: http://192.168.1.1:8082

# âœ… æ­£ç¡®é…ç½®ï¼ˆåŠ¨æ€å‘ç°ï¼‰
uri: lb://orderservice
```

**é—®é¢˜3ï¼šæŸå°orderserviceæŒ‚äº†ï¼ŒGatewayè¿˜å¾€é‚£å°å‘è¯·æ±‚**

è§£å†³ï¼šNacoså¥åº·æ£€æŸ¥ï¼Œè‡ªåŠ¨å‰”é™¤æ•…éšœå®ä¾‹

```yaml
spring:
  cloud:
    nacos:
      discovery:
        heart-beat-interval: 5000      # 5ç§’å¿ƒè·³
        heart-beat-timeout: 15000      # 15ç§’è¶…æ—¶
```

**é—®é¢˜4ï¼šé«˜å¹¶å‘æ—¶Gatewayæˆä¸ºç“¶é¢ˆ**

è§£å†³ï¼šéƒ¨ç½²å¤šå°Gatewayï¼ŒNginxè´Ÿè½½å‡è¡¡

```nginx
# nginx.conf
upstream gateway_backend {
    server 192.168.1.1:10010;
    server 192.168.1.2:10010;
    server 192.168.1.3:10010;
}
```

**é—®é¢˜5ï¼šè·¨åŸŸé—®é¢˜ï¼Œå‰ç«¯è¯·æ±‚è¢«æ‹¦æˆª**

è§£å†³ï¼šGatewayé…ç½®å…¨å±€è·¨åŸŸ

```yaml
spring:
  cloud:
    gateway:
      globalcors:
        cors-configurations:
          '[/**]':
            allowed-origins: "*"
            allowed-methods: "*"
            allowed-headers: "*"
```

### ç¬¬5å±‚ï¼šå…³é”®é…ç½®

**å®Œæ•´é…ç½®æ–‡ä»¶ï¼š**

```yaml
# gateway/application.yml
server:
  port: 10010

spring:
  application:
    name: gateway
  cloud:
    nacos:
      server-addr: localhost:8848
    gateway:
      routes:
        - id: order-service
          uri: lb://orderservice
          predicates:
            - Path=/order/**
        - id: user-service
          uri: lb://userservice
          predicates:
            - Path=/user/**
      default-filters:
        - AddRequestHeader=Gateway, true
      globalcors:
        cors-configurations:
          '[/**]':
            allowed-origins: "*"
            allowed-methods: "*"
            allowed-headers: "*"
```

**æ€§èƒ½æ•°æ®ï¼š**

```
å•å°Gatewayæ€§èƒ½ï¼š
- QPS: 1ä¸‡+
- å“åº”æ—¶é—´: 5-10msï¼ˆä¸å«åç«¯æœåŠ¡å¤„ç†æ—¶é—´ï¼‰
- å¹¶å‘è¿æ¥: 1ä¸‡+

3å°Gatewayé›†ç¾¤ï¼š
- QPS: 3ä¸‡+
- é«˜å¯ç”¨ï¼šä¸€å°æŒ‚äº†ï¼Œè‡ªåŠ¨åˆ‡æ¢
```

---

## ã€ç‰ˆæœ¬C - å®æˆ˜åœºæ™¯ã€‘ç»ˆæç‰ˆ

### ç¬¬1å±‚ï¼šä¸»æ—¨ï¼ˆæ ¸å¿ƒä¸­çš„æ ¸å¿ƒï¼‰

```
Gateway(10010)ç»Ÿä¸€å…¥å£ï¼ŒéªŒè¯Tokenï¼ŒåŒ¹é…è·¯ç”±ï¼ŒNacosæŸ¥æœåŠ¡ï¼Œè´Ÿè½½å‡è¡¡è½¬å‘
```

### ç¬¬2å±‚ï¼šæ ¸å¿ƒä»·å€¼

```
å‰ç«¯ç»Ÿä¸€åœ°å€ + ç»Ÿä¸€é‰´æƒ + åŠ¨æ€è·¯ç”±
```

### ç¬¬3å±‚ï¼šå®é™…æ¡ˆä¾‹ï¼ˆä½ çš„é¡¹ç›®å®Œæ•´æµç¨‹ï¼‰

**ç”¨æˆ·æ“ä½œï¼šç‚¹å‡»"æˆ‘çš„è®¢å•"æŒ‰é’®**

**å‰ç«¯ä»£ç ï¼š**
```javascript
axios.get('http://localhost:8005/api/order/list', {
  headers: { Authorization: 'Bearer ' + token }
})
```

**è¯·æ±‚æµç¨‹ï¼š**
```
1. Nginx(8005)æ¥æ”¶ â†’ å»æ‰/api/ â†’ è½¬å‘åˆ°Gateway(10010)
2. GatewayéªŒè¯Token â†’ è§£æuserId=123
3. GatewayåŒ¹é…è·¯ç”±/order/** â†’ æ‰¾åˆ°orderservice
4. Nacosè¿”å›orderserviceå®ä¾‹[8081,8082,8083]
5. Gatewayè´Ÿè½½å‡è¡¡é€‰8081 â†’ è½¬å‘è¯·æ±‚(å¸¦userId)
6. orderservice(8081)æŸ¥è¯¢userId=123çš„è®¢å• â†’ è¿”å›æ•°æ®
7. åŸè·¯è¿”å› â†’ å‰ç«¯æ˜¾ç¤ºè®¢å•åˆ—è¡¨
```

### ç¬¬4å±‚ï¼šé—®é¢˜è§£å†³ï¼ˆçœŸå®è¸©å‘ï¼‰

**å‘1ï¼šTokenéªŒè¯æ¯ä¸ªæœåŠ¡éƒ½å†™ï¼Œæ”¹ä¸€æ¬¡æ”¹100å¤„**
```
è§£å†³ï¼šGatewayç»Ÿä¸€éªŒè¯ï¼Œåç«¯æœåŠ¡åªéœ€ä»Headerå–userId
```

**å‘2ï¼šorderserviceæ”¹ç«¯å£ï¼Œå‰ç«¯è¦é‡æ–°å‘å¸ƒ**
```
è§£å†³ï¼šç”¨lb://orderserviceï¼ŒNacosè‡ªåŠ¨å‘ç°ï¼Œå‰ç«¯æ— æ„ŸçŸ¥
```

**å‘3ï¼šæŸå°orderserviceæŒ‚äº†ï¼Œç”¨æˆ·æŠ¥é”™**
```
è§£å†³ï¼šNacoså¥åº·æ£€æŸ¥ï¼Œè‡ªåŠ¨å‰”é™¤æ•…éšœå®ä¾‹ï¼Œç”¨æˆ·æ— æ„ŸçŸ¥
```

**å‘4ï¼šè·¨åŸŸé—®é¢˜ï¼Œå‰ç«¯è¯·æ±‚è¢«æ‹¦æˆª**
```
è§£å†³ï¼šGatewayé…ç½®å…¨å±€è·¨åŸŸ
gateway:
  globalcors:
    cors-configurations:
      '[/**]':
        allowed-origins: "*"
        allowed-methods: "*"
```

### ç¬¬5å±‚ï¼šå…³é”®é…ç½®ï¼ˆæ‹¿æ¥å°±ç”¨ï¼‰

```yaml
routes:
  - id: order-service
    uri: lb://orderservice
    predicates:
      - Path=/order/**
```

---

## ğŸ”„ å®Œæ•´è¯·æ±‚æµç¨‹å›¾

```
ç”¨æˆ·æµè§ˆå™¨
  â†“ http://localhost:8005/api/order/list
  â†“ Header: Authorization: Bearer eyJhbGc...
  
Nginx (8005)
  â†“ åŒ¹é… location /api/
  â†“ å»æ‰ /api/ å‰ç¼€
  â†“ proxy_pass http://gateway_backend/
  â†“ è½¬å‘åˆ° http://localhost:10010/order/list
  
Gateway (10010)
  â†“ GlobalFilter: AuthFilter
  â†“ éªŒè¯Tokenç­¾åå’Œè¿‡æœŸæ—¶é—´
  â†“ è§£æuserId=123
  â†“ æ·»åŠ Header: userId=123
  â†“ 
  â†“ åŒ¹é…è·¯ç”±è§„åˆ™
  â†“ predicates: Path=/order/**
  â†“ æ‰¾åˆ° routes: order-service
  â†“ uri: lb://orderservice
  â†“
  â†“ æŸ¥è¯¢Nacos
  
Nacos (8848)
  â†“ è¿”å›orderserviceçš„å¥åº·å®ä¾‹
  â†“ [192.168.1.1:8081, 192.168.1.2:8082, 192.168.1.3:8083]
  
Gateway (10010)
  â†“ è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼šè½®è¯¢
  â†“ é€‰æ‹©ï¼š192.168.1.1:8081
  â†“ è½¬å‘è¯·æ±‚
  â†“ Header: userId=123
  
orderservice (8081)
  â†“ ä»Headerå–userId=123
  â†“ æŸ¥è¯¢æ•°æ®åº“ï¼šSELECT * FROM orders WHERE user_id=123
  â†“ è¿”å›è®¢å•åˆ—è¡¨
  
åŸè·¯è¿”å›
  â†“ orderservice â†’ Gateway â†’ Nginx â†’ ç”¨æˆ·æµè§ˆå™¨
  â†“ å‰ç«¯æ˜¾ç¤ºè®¢å•åˆ—è¡¨
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### æ²¡æœ‰Gateway vs æœ‰Gateway

| å¯¹æ¯”é¡¹ | æ²¡æœ‰Gateway | æœ‰Gateway | å·®å¼‚ |
|--------|------------|-----------|------|
| å‰ç«¯åœ°å€ | è®°100ä¸ªæœåŠ¡åœ°å€ | åªè®°1ä¸ªåœ°å€ | ç®€åŒ–100å€ |
| é‰´æƒä»£ç  | æ¯ä¸ªæœåŠ¡éƒ½å†™ | Gatewayç»Ÿä¸€éªŒè¯ | ä»£ç å‡å°‘100å€ |
| åœ°å€å˜æ›´ | å‰ç«¯è¦æ”¹é…ç½® | å‰ç«¯æ— æ„ŸçŸ¥ | é›¶æ”¹åŠ¨ |
| æœåŠ¡æ•…éšœ | ç”¨æˆ·æŠ¥é”™ | è‡ªåŠ¨åˆ‡æ¢ | é«˜å¯ç”¨ |

### Gatewayæ€§èƒ½æ•°æ®

| æŒ‡æ ‡ | å•å°Gateway | 3å°Gatewayé›†ç¾¤ |
|------|------------|---------------|
| QPS | 1ä¸‡+ | 3ä¸‡+ |
| å“åº”æ—¶é—´ | 5-10ms | 5-10ms |
| å¹¶å‘è¿æ¥ | 1ä¸‡+ | 3ä¸‡+ |
| å¯ç”¨æ€§ | å•ç‚¹æ•…éšœ | é«˜å¯ç”¨ |

---

## ğŸ¯ ä½¿ç”¨å»ºè®®

### ä»€ä¹ˆæ—¶å€™çœ‹ç²¾ç®€ç‰ˆï¼ˆGateway.mdï¼‰
- é¢è¯•å‰å¿«é€Ÿå¤ä¹ 
- æ—¥å¸¸å¿«é€ŸæŸ¥é˜…
- åªéœ€è¦æ ¸å¿ƒæ¦‚å¿µ

### ä»€ä¹ˆæ—¶å€™çœ‹è¯¦ç»†ç‰ˆï¼ˆæœ¬æ–‡ä»¶ï¼‰
- æ·±å…¥å­¦ä¹ GatewayåŸç†
- å®é™…é¡¹ç›®å¼€å‘é…ç½®
- é‡åˆ°é—®é¢˜éœ€è¦è§£å†³æ–¹æ¡ˆ
- éœ€è¦å®Œæ•´çš„ä»£ç ç¤ºä¾‹

---

## ğŸ“ è¡¥å……è¯´æ˜

### å’ŒNginxçš„å…³ç³»
```
Nginx(8005) - è¾¹ç¼˜ç½‘å…³å±‚
- èŒè´£ï¼šå®‰å…¨é˜²æŠ¤ã€é™æ€ç¼“å­˜ã€SSLå¸è½½
- ä½ç½®ï¼šæœ€å¤–å±‚ï¼Œå¯¹å¤–æš´éœ²

Gateway(10010) - ä¸šåŠ¡ç½‘å…³å±‚
- èŒè´£ï¼šæœåŠ¡è·¯ç”±ã€ä¸šåŠ¡é‰´æƒã€è´Ÿè½½å‡è¡¡
- ä½ç½®ï¼šå†…å±‚ï¼Œä¸å¯¹å¤–æš´éœ²
```

### æŠ€æœ¯æ ˆ
```
- Spring Cloud Gateway 3.x
- Spring WebFluxï¼ˆå“åº”å¼ç¼–ç¨‹ï¼‰
- Nacos 2.xï¼ˆæœåŠ¡æ³¨å†Œä¸å‘ç°ï¼‰
- JWTï¼ˆTokenéªŒè¯ï¼‰
```

---

**æœ€åæ›´æ–°ï¼š** 2026-01-29  
**é€‚ç”¨åœºæ™¯ï¼š** æ·±å…¥å­¦ä¹ ã€å®é™…å¼€å‘ã€é—®é¢˜è§£å†³  
**é…å¥—æ–‡ä»¶ï¼š** Gateway.mdï¼ˆç²¾ç®€ç‰ˆï¼‰
